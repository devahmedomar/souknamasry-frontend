<div class="container py-5">
    <!-- Stepper -->
    <div class="d-flex justify-content-center mb-4">
        <div style="max-width: 600px; width: 100%;">
            <p-stepper [value]="activeStep()" [linear]="true">
                <p-step-list>
                    <p-step [value]="1">{{ 'CART_PAGE.STEP_CART' | translate }}</p-step>
                    <p-step [value]="2">{{ 'CART_PAGE.STEP_ADDRESS' | translate }}</p-step>
                </p-step-list>
            </p-stepper>
        </div>
    </div>

    <!-- Step Content -->
    @if (activeStep() === 1) {
    <!-- Cart Step -->
    @if (loading()) {
    <div class="row mt-4">
        <!-- Cart Items Skeleton -->
        <div class="col-lg-8">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="skeleton skeleton-title" style="width: 150px;"></div>
                <div class="skeleton skeleton-text" style="width: 100px;"></div>
            </div>
            <app-cart-item-skeleton [count]="3"></app-cart-item-skeleton>
        </div>
        <!-- Order Summary Skeleton -->
        <div class="col-lg-4">
            <div class="card border shadow-sm">
                <div class="card-body">
                    <div class="skeleton skeleton-title mb-4"></div>
                    <div class="skeleton skeleton-text skeleton-w-100 mb-2"></div>
                    <div class="skeleton skeleton-text skeleton-w-75 mb-2"></div>
                    <div class="skeleton skeleton-text skeleton-w-50 mb-3"></div>
                    <div class="skeleton skeleton-button w-100 mt-3"></div>
                </div>
            </div>
        </div>
    </div>
    } @else if (isEmpty()) {
    <div class="text-center py-5">
        <i class="fas fa-shopping-cart fa-4x text-muted mb-3"></i>
        <h4 class="text-muted">{{ 'CART_PAGE.EMPTY_CART' | translate }}</h4>
        <a routerLink="/categories" class="btn btn-primary mt-3">
            {{ 'CART_PAGE.CONTINUE_SHOPPING' | translate }}
        </a>
    </div>
    } @else {
    <div class="row mt-4">
        <!-- Cart Items -->
        <div class="col-lg-8">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">{{ 'CART_PAGE.ITEMS_IN_CART' | translate: {count: cart()!.itemCount} }}</h5>
                <button type="button" class="btn btn-link text-danger p-0" (click)="clearCart()"
                    [disabled]="clearingCart()">
                    @if (clearingCart()) {
                    <span class="spinner-border spinner-border-sm me-1"></span>
                    } @else {
                    <i class="fas fa-trash me-1"></i>
                    }
                    {{ 'CART_PAGE.CLEAR_CART' | translate }}
                </button>
            </div>

            <!-- Cart Item List using CartItemComponent -->
            @for (item of cart()!.items; track item._id) {
            <app-cart-item [item]="item" [updating]="isItemUpdating(item._id)" [removing]="isItemRemoving(item._id)"
                (quantityChange)="updateQuantity(item._id, $event)" (remove)="removeItem(item._id)">
            </app-cart-item>
            }
        </div>

        <!-- Order Summary -->
        <div class="col-lg-4">
            <app-order-summary [cart]="cart()!" [showCoupon]="true" [showCheckoutButton]="true"
                [checkoutButtonText]="'CART_PAGE.CONTINUE_SHIPPING'" [applyingCoupon]="applyingCoupon()"
                [showBackButton]="false" (checkout)="continueToShipping()" (applyCoupon)="applyCoupon($event)">
            </app-order-summary>
        </div>
    </div>
    }
    } @else if (activeStep() === 2) {
    <!-- Address Step -->
    <div class="row">
        <!-- Address Selection (Right Column) -->
        <div class="col-lg-8 order-lg-2">
            @if (loadingAddresses()) {
            <div class="row g-3">
                @for (i of [1, 2, 3, 4]; track i) {
                <div class="col-md-6">
                    <app-address-card-skeleton></app-address-card-skeleton>
                </div>
                }
            </div>
            } @else if (addresses().length === 0) {
            <div class="text-center py-5">
                <i class="fas fa-map-marker-alt fa-4x text-muted mb-3"></i>
                <h4 class="text-muted">{{ 'CART_PAGE.NO_ADDRESSES_TITLE' | translate }}</h4>
                <p>{{ 'CART_PAGE.NO_ADDRESSES_MESSAGE' | translate }}</p>
                <button type="button" class="btn btn-primary mt-3" (click)="router.navigate(['/user/profile'])">
                    {{ 'CART_PAGE.GO_TO_PROFILE' | translate }}
                </button>
            </div>
            } @else {
            <app-address-selector [addresses]="addresses()" [selectedAddressId]="selectedAddress()?._id || null"
                [loading]="loadingAddresses()" (selectAddress)="selectAddress($event)" (addNewAddress)="addNewAddress()"
                (deleteAddress)="deleteAddress($event)">
            </app-address-selector>

            <!-- Order Notes Section -->
            <div class="card border shadow-sm mt-4">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-sticky-note me-2"></i>
                        {{ 'CART_PAGE.ORDER_NOTES' | translate }}
                    </h5>
                    <div class="form-group">
                        <label for="orderNotes" class="form-label text-muted small">
                            {{ 'CART_PAGE.ORDER_NOTES_PLACEHOLDER' | translate }}
                        </label>
                        <textarea id="orderNotes" class="form-control" rows="3" maxlength="500" [value]="orderNotes()"
                            (input)="updateOrderNotes($any($event.target).value)"
                            [placeholder]="'CART_PAGE.ORDER_NOTES_EXAMPLE' | translate">
                        </textarea>
                        <div class="d-flex justify-content-between mt-2">
                            <small class="text-muted">{{ 'CART_PAGE.ORDER_NOTES_HINT' | translate }}</small>
                            <small class="text-muted">{{ orderNotes().length }}/500</small>
                        </div>
                    </div>
                </div>
            </div>
            }
        </div>

        <!-- Order Summary (Left Column) -->
        <div class="col-lg-4 order-lg-1">
            <div class="card border shadow-sm sticky-top mb-4" style="top: 100px;">
                <div class="card-body">
                    <h5 class="card-title mb-4">{{ 'CART_PAGE.ORDER_SUMMARY' | translate }}</h5>

                    <!-- Mini Cart Items List using CartItemComponent -->
                    <div class="mb-3">
                        @for (item of cart()!.items; track item._id) {
                        <app-cart-item [item]="item" [compact]="true" [removing]="isItemRemoving(item._id)"
                            (remove)="removeItem(item._id)">
                        </app-cart-item>
                        }
                    </div>

                    <div class="d-flex justify-content-between mb-2">
                        <span>{{ 'CART_PAGE.SHIPPING' | translate }}</span>
                        <span>
                            @if (cart()!.shipping === 0) {
                            {{ 'CART_PAGE.FREE' | translate }}
                            } @else {
                            {{ cart()!.shipping | price }}
                            }
                        </span>
                    </div>

                    <div class="d-flex justify-content-between mb-4">
                        <strong>{{ 'CART_PAGE.TOTAL' | translate }}</strong>
                        <strong class="fs-5">{{ cart()!.total | price }}</strong>
                    </div>

                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" type="button" (click)="confirmOrder()"
                            [disabled]="!selectedAddress() || creatingOrder()">
                            @if (creatingOrder()) {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                            {{ 'CART_PAGE.CREATING_ORDER' | translate }}
                            } @else {
                            {{ 'CART_PAGE.CONFIRM_ORDER' | translate }}
                            }
                        </button>
                        <button class="btn btn-outline-secondary" type="button" (click)="backToCart()"
                            [disabled]="creatingOrder()">
                            {{ 'CART_PAGE.BACK_TO_CART' | translate }}
                        </button>

                        <div class="mt-3 text-center small text-muted">
                            <div><i class="fas fa-shield-alt me-1"></i> دفع آمن ومضمون عند التوصيل</div>
                            <div class="mt-1"><i class="fas fa-undo me-1"></i> إمكانية الارجاع خلال 14 يوم</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    }
</div>
