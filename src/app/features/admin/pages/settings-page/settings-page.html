<p-toast />
<p-confirmDialog />

<div class="p-4">
  <div class="d-flex align-items-center justify-content-between mb-4">
    <h2 class="h4 mb-0">
      <i class="pi pi-palette me-2"></i>
      {{ 'ADMIN.SETTINGS.TITLE' | translate }}
    </h2>
    <p-button
      icon="pi pi-plus"
      [label]="'ADMIN.SETTINGS.ADD_THEME' | translate"
      severity="primary"
      (onClick)="openCreateDialog()"
    />
  </div>

  <!-- Active Theme Banner -->
  <div class="active-theme-banner mb-4 p-3 rounded border border-success bg-success bg-opacity-10">
    <div class="d-flex align-items-center gap-2">
      <i class="pi pi-check-circle text-success fs-5"></i>
      <span class="fw-semibold">{{ 'ADMIN.SETTINGS.ACTIVE_THEME' | translate }}:</span>
      <span class="badge bg-success fs-6">{{ activeTheme() }}</span>
    </div>
  </div>

  <!-- Themes Table -->
  <p-table
    [value]="themes()"
    [loading]="loading()"
    styleClass="p-datatable-sm p-datatable-striped"
    [rowHover]="true"
  >
    <ng-template #header>
      <tr>
        <th>{{ 'ADMIN.SETTINGS.THEME_KEY' | translate }}</th>
        <th>{{ 'ADMIN.SETTINGS.THEME_NAME_EN' | translate }}</th>
        <th>{{ 'ADMIN.SETTINGS.THEME_NAME_AR' | translate }}</th>
        <th>{{ 'ADMIN.SETTINGS.THEME_TYPE' | translate }}</th>
        <th>{{ 'ADMIN.SETTINGS.THEME_STATUS' | translate }}</th>
        <th>{{ 'ADMIN.SETTINGS.THEME_ACTIVE' | translate }}</th>
        <th>{{ 'COMMON.ACTIONS' | translate }}</th>
      </tr>
    </ng-template>

    <ng-template #body let-theme>
      <tr [class.active-row]="theme.key === activeTheme()">
        <td>
          <code>{{ theme.key }}</code>
        </td>
        <td>{{ theme.nameEn }}</td>
        <td>{{ theme.nameAr }}</td>
        <td>
          <p-tag
            [value]="theme.isBuiltIn ? ('ADMIN.SETTINGS.BUILT_IN' | translate) : ('ADMIN.SETTINGS.CUSTOM' | translate)"
            [severity]="theme.isBuiltIn ? 'info' : 'secondary'"
          />
        </td>
        <td>
          <p-tag
            [value]="theme.isEnabled ? ('COMMON.ACTIVE' | translate) : ('COMMON.INACTIVE' | translate)"
            [severity]="theme.isEnabled ? 'success' : 'danger'"
          />
        </td>
        <td>
          @if (theme.key === activeTheme()) {
            <p-tag value="{{ 'ADMIN.SETTINGS.ACTIVE' | translate }}" severity="success" icon="pi pi-check" />
          } @else {
            <p-button
              [label]="'ADMIN.SETTINGS.SET_ACTIVE' | translate"
              severity="secondary"
              size="small"
              (onClick)="setActiveTheme(theme.key)"
            />
          }
        </td>
        <td>
          <div class="d-flex gap-2">
            <p-button
              icon="pi pi-pencil"
              severity="secondary"
              size="small"
              [pTooltip]="'COMMON.EDIT' | translate"
              tooltipPosition="top"
              (onClick)="openEditDialog(theme)"
            />
            @if (!theme.isBuiltIn && theme.key !== activeTheme()) {
              <p-button
                icon="pi pi-trash"
                severity="danger"
                size="small"
                [pTooltip]="'COMMON.DELETE' | translate"
                tooltipPosition="top"
                (onClick)="confirmDelete(theme)"
              />
            }
          </div>
        </td>
      </tr>
    </ng-template>

    <ng-template #emptymessage>
      <tr>
        <td colspan="7" class="text-center text-muted py-4">
          {{ 'ADMIN.SETTINGS.NO_THEMES' | translate }}
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>

<!-- Create Theme Dialog -->
<p-dialog
  [header]="'ADMIN.SETTINGS.ADD_THEME' | translate"
  [visible]="showCreateDialog()"
  (visibleChange)="showCreateDialog.set($event)"
  [modal]="true"
  [style]="{ width: '480px' }"
  [draggable]="false"
>
  <form [formGroup]="createForm" (ngSubmit)="submitCreate()" class="d-flex flex-column gap-3 pt-2">
    <div class="d-flex flex-column gap-1">
      <label class="form-label fw-semibold" for="create-key">
        {{ 'ADMIN.SETTINGS.THEME_KEY' | translate }} <span class="text-danger">*</span>
      </label>
      <input
        id="create-key"
        pInputText
        formControlName="key"
        placeholder="e.g. ramadan"
        class="w-100"
      />
      @if (createForm.get('key')?.invalid && createForm.get('key')?.touched) {
        <small class="text-danger">{{ 'ADMIN.SETTINGS.KEY_HINT' | translate }}</small>
      }
    </div>

    <div class="d-flex flex-column gap-1">
      <label class="form-label fw-semibold" for="create-nameEn">
        {{ 'ADMIN.SETTINGS.THEME_NAME_EN' | translate }} <span class="text-danger">*</span>
      </label>
      <input id="create-nameEn" pInputText formControlName="nameEn" class="w-100" />
    </div>

    <div class="d-flex flex-column gap-1">
      <label class="form-label fw-semibold" for="create-nameAr">
        {{ 'ADMIN.SETTINGS.THEME_NAME_AR' | translate }} <span class="text-danger">*</span>
      </label>
      <input id="create-nameAr" pInputText formControlName="nameAr" class="w-100" dir="rtl" />
    </div>

    <div class="d-flex align-items-center gap-2">
      <p-toggleswitch formControlName="isEnabled" inputId="create-enabled" />
      <label for="create-enabled">{{ 'ADMIN.SETTINGS.THEME_ENABLED' | translate }}</label>
    </div>

    <div class="d-flex justify-content-end gap-2 pt-2">
      <p-button
        [label]="'COMMON.CANCEL' | translate"
        severity="secondary"
        (onClick)="showCreateDialog.set(false)"
      />
      <p-button
        type="submit"
        [label]="'COMMON.SAVE' | translate"
        [loading]="saving()"
        [disabled]="createForm.invalid"
      />
    </div>
  </form>
</p-dialog>

<!-- Edit Theme Dialog -->
<p-dialog
  [header]="'COMMON.EDIT' | translate"
  [visible]="showEditDialog()"
  (visibleChange)="showEditDialog.set($event)"
  [modal]="true"
  [style]="{ width: '480px' }"
  [draggable]="false"
>
  <form [formGroup]="editForm" (ngSubmit)="submitEdit()" class="d-flex flex-column gap-3 pt-2">
    <div class="d-flex flex-column gap-1">
      <label class="form-label fw-semibold" for="edit-nameEn">
        {{ 'ADMIN.SETTINGS.THEME_NAME_EN' | translate }} <span class="text-danger">*</span>
      </label>
      <input id="edit-nameEn" pInputText formControlName="nameEn" class="w-100" />
    </div>

    <div class="d-flex flex-column gap-1">
      <label class="form-label fw-semibold" for="edit-nameAr">
        {{ 'ADMIN.SETTINGS.THEME_NAME_AR' | translate }} <span class="text-danger">*</span>
      </label>
      <input id="edit-nameAr" pInputText formControlName="nameAr" class="w-100" dir="rtl" />
    </div>

    <div class="d-flex align-items-center gap-2">
      <p-toggleswitch formControlName="isEnabled" inputId="edit-enabled" />
      <label for="edit-enabled">{{ 'ADMIN.SETTINGS.THEME_ENABLED' | translate }}</label>
    </div>

    <div class="d-flex justify-content-end gap-2 pt-2">
      <p-button
        [label]="'COMMON.CANCEL' | translate"
        severity="secondary"
        (onClick)="showEditDialog.set(false)"
      />
      <p-button
        type="submit"
        [label]="'COMMON.UPDATE' | translate"
        [loading]="saving()"
        [disabled]="editForm.invalid"
      />
    </div>
  </form>
</p-dialog>
