<div class="container-fluid p-4">
  <!-- Header -->
  <div class="page-header">
    <h1>ðŸ“¦ {{ 'ADMIN.ORDERS.TITLE' | translate }}</h1>
    <p>{{ 'ADMIN.ORDERS.SUBTITLE' | translate }}</p>
  </div>

  <!-- Filters -->
  <div class="filters-card">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label small text-muted">{{ 'ADMIN.ORDERS.SEARCH_LABEL' | translate }}</label>
          <span class="p-input-icon-left w-100">
            <i class="pi pi-search"></i>
            <input
              type="text"
              pInputText
              [placeholder]="'ADMIN.ORDERS.SEARCH_PLACEHOLDER' | translate"
              class="w-100"
              [(ngModel)]="searchTerm"
              (keyup.enter)="onSearch()"
            />
          </span>
        </div>
        <div class="col-md-2">
          <label class="form-label small text-muted">{{ 'ADMIN.ORDERS.ORDER_STATUS_LABEL' | translate }}</label>
          <p-select
            [options]="orderStatusOptions"
            [(ngModel)]="selectedOrderStatus"
            optionLabel="label"
            optionValue="value"
            [placeholder]="'ADMIN.ORDERS.SELECT_STATUS_PLACEHOLDER' | translate"
            class="w-100"
            (onChange)="onFilterChange()"
          ></p-select>
        </div>
        <div class="col-md-2">
          <label class="form-label small text-muted">{{ 'ADMIN.ORDERS.PAYMENT_STATUS_LABEL' | translate }}</label>
          <p-select
            [options]="paymentStatusOptions"
            [(ngModel)]="selectedPaymentStatus"
            optionLabel="label"
            optionValue="value"
            [placeholder]="'ADMIN.ORDERS.SELECT_PAYMENT_PLACEHOLDER' | translate"
            class="w-100"
            (onChange)="onFilterChange()"
          ></p-select>
        </div>
        <div class="col-md-2">
          <label class="form-label small text-muted">{{ 'ADMIN.ORDERS.START_DATE_LABEL' | translate }}</label>
          <p-datepicker
            [(ngModel)]="startDate"
            dateFormat="yy-mm-dd"
            [placeholder]="'ADMIN.ORDERS.START_DATE_PLACEHOLDER' | translate"
            class="w-100"
            (onSelect)="onFilterChange()"
            [showIcon]="true"
          ></p-datepicker>
        </div>
        <div class="col-md-2">
          <label class="form-label small text-muted">{{ 'ADMIN.ORDERS.END_DATE_LABEL' | translate }}</label>
          <p-datepicker
            [(ngModel)]="endDate"
            dateFormat="yy-mm-dd"
            [placeholder]="'ADMIN.ORDERS.END_DATE_PLACEHOLDER' | translate"
            class="w-100"
            (onSelect)="onFilterChange()"
            [showIcon]="true"
          ></p-datepicker>
        </div>
        <div class="col-md-1 d-flex align-items-end">
          <button
            pButton
            type="button"
            icon="pi pi-search"
            class="w-100"
            (click)="onSearch()"
            [pTooltip]="'ADMIN.ORDERS.SEARCH_BUTTON' | translate"
          ></button>
        </div>
      </div>
    </div>
  </div>

  <!-- Orders Table -->
  <div class="table-card">
    <p-table
        [value]="orders()"
        [loading]="loading()"
        [paginator]="true"
        [rows]="rowsPerPage()"
        [totalRecords]="totalRecords()"
        [lazy]="true"
        (onLazyLoad)="onPageChange($event)"
        [rowsPerPageOptions]="[10, 20, 50, 100]"
        [showCurrentPageReport]="true"
        [currentPageReportTemplate]="'ADMIN.ORDERS.PAGINATION_TEXT' | translate"
        styleClass="p-datatable-striped"
      >
        <ng-template pTemplate="header">
          <tr>
            <th>{{ 'ADMIN.ORDERS.TABLE_ORDER_NUMBER' | translate }}</th>
            <th>{{ 'ADMIN.ORDERS.TABLE_CUSTOMER' | translate }}</th>
            <th>{{ 'ADMIN.ORDERS.TABLE_ITEMS' | translate }}</th>
            <th>{{ 'ADMIN.ORDERS.TABLE_TOTAL_AMOUNT' | translate }}</th>
            <th>{{ 'ADMIN.ORDERS.TABLE_ORDER_STATUS' | translate }}</th>
            <th>{{ 'ADMIN.ORDERS.TABLE_PAYMENT_STATUS' | translate }}</th>
            <th>{{ 'ADMIN.ORDERS.TABLE_DATE' | translate }}</th>
            <th style="width: 250px;">{{ 'ADMIN.ORDERS.TABLE_ACTIONS' | translate }}</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-order>
          <tr>
            <td>
              <strong>{{ order.orderNumber }}</strong>
            </td>
            <td>
              <div>
                <strong>{{ order.user.firstName }} {{ order.user.lastName }}</strong>
                <br /><small class="text-muted">{{ order.user.email }}</small>
              </div>
            </td>
            <td>{{ order.items.length }} {{ 'ADMIN.ORDERS.ITEMS_COUNT' | translate }}</td>
            <td>
              <strong>{{ formatCurrency(order.total) }}</strong>
            </td>
            <td>
              <p-tag
                [value]="order.status"
                [severity]="getOrderStatusSeverity(order.status)"
              ></p-tag>
            </td>
            <td>
              <p-tag
                [value]="order.paymentStatus"
                [severity]="getPaymentStatusSeverity(order.paymentStatus)"
              ></p-tag>
            </td>
            <td>{{ order.createdAt | date: 'short' }}</td>
            <td>
              <div class="d-flex gap-2">
                <button
                  pButton
                  type="button"
                  icon="pi pi-eye"
                  class="p-button-rounded p-button-text p-button-sm"
                  [pTooltip]="'ADMIN.ORDERS.VIEW_DETAILS_TOOLTIP' | translate"
                  (click)="openDetailsDialog(order)"
                ></button>
                <button
                  pButton
                  type="button"
                  icon="pi pi-refresh"
                  class="p-button-rounded p-button-text p-button-sm"
                  [pTooltip]="'ADMIN.ORDERS.UPDATE_ORDER_STATUS_TOOLTIP' | translate"
                  (click)="openOrderStatusDialog(order)"
                ></button>
                <button
                  pButton
                  type="button"
                  icon="pi pi-dollar"
                  class="p-button-rounded p-button-text p-button-sm"
                  [pTooltip]="'ADMIN.ORDERS.UPDATE_PAYMENT_STATUS_TOOLTIP' | translate"
                  (click)="openPaymentStatusDialog(order)"
                ></button>
                <button
                  pButton
                  type="button"
                  icon="pi pi-trash"
                  class="p-button-rounded p-button-text p-button-danger p-button-sm"
                  [pTooltip]="'ADMIN.ORDERS.DELETE_TOOLTIP' | translate"
                  (click)="deleteOrder(order)"
                ></button>
              </div>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="8" class="text-center py-5">
              <i class="pi pi-shopping-cart" style="font-size: 4rem; color: #cbd5e1;"></i>
              <p class="text-muted mt-3 mb-0" style="font-size: 1.125rem; font-weight: 500;">{{ 'ADMIN.ORDERS.NO_ORDERS_FOUND' | translate }}</p>
              <p class="text-muted" style="font-size: 0.875rem;">{{ 'ADMIN.ORDERS.NO_ORDERS_MESSAGE' | translate }}</p>
            </td>
          </tr>
        </ng-template>
      </p-table>
  </div>
</div>

<!-- Order Details Dialog -->
<p-dialog
  [(visible)]="showDetailsDialog"
  [header]="'ðŸ“‹ ' + ('ADMIN.ORDERS.DETAILS_DIALOG_TITLE' | translate)"
  [modal]="true"
  [style]="{ width: '800px' }"
  [closable]="true"
  [draggable]="false"
  [resizable]="false"
  (onHide)="closeDetailsDialog()"
>
  @if (selectedOrder()) {
    <div class="order-details">
      <!-- Order Info -->
      <div class="row mb-4">
        <div class="col-md-6">
          <h6 class="text-muted">{{ 'ADMIN.ORDERS.ORDER_NUMBER' | translate }}</h6>
          <p class="fw-bold">{{ selectedOrder()!.orderNumber }}</p>
        </div>
        <div class="col-md-6">
          <h6 class="text-muted">{{ 'ADMIN.ORDERS.ORDER_DATE' | translate }}</h6>
          <p>{{ selectedOrder()!.createdAt | date: 'medium' }}</p>
        </div>
      </div>

      <!-- Customer Info -->
      <div class="mb-4">
        <h6 class="text-muted">{{ 'ADMIN.ORDERS.CUSTOMER_INFO' | translate }}</h6>
        <p class="mb-1">
          <strong>{{ selectedOrder()!.user.firstName }} {{ selectedOrder()!.user.lastName }}</strong>
        </p>
        <p class="mb-1">{{ selectedOrder()!.user.email }}</p>
      </div>

      <!-- Shipping Address -->
      <div class="mb-4">
        <h6 class="text-muted">{{ 'ADMIN.ORDERS.SHIPPING_ADDRESS' | translate }}</h6>
        <p class="mb-1">
          {{ selectedOrder()!.shippingAddress.name }}
        </p>
        <p class="mb-1">{{ selectedOrder()!.shippingAddress.phone }}</p>
        <p class="mb-0">{{ getFullAddress(selectedOrder()!) }}</p>
      </div>

      <!-- Order Items -->
      <div class="mb-4">
        <h6 class="text-muted mb-3">{{ 'ADMIN.ORDERS.ORDER_ITEMS' | translate }}</h6>
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>{{ 'ADMIN.ORDERS.PRODUCT_COLUMN' | translate }}</th>
                <th>{{ 'ADMIN.ORDERS.PRICE_COLUMN' | translate }}</th>
                <th>{{ 'ADMIN.ORDERS.QUANTITY_COLUMN' | translate }}</th>
                <th>{{ 'ADMIN.ORDERS.TOTAL_COLUMN' | translate }}</th>
              </tr>
            </thead>
            <tbody>
              @for (item of selectedOrder()!.items; track item.product) {
                <tr>
                  <td>
                    <div class="d-flex align-items-center">
                      @if (item.productSnapshot.image) {
                        <img
                          [src]="item.productSnapshot.image"
                          [alt]="getSnapshotName(item.productSnapshot)"
                          class="rounded me-2"
                          width="40"
                          height="40"
                          style="object-fit: cover;"
                        />
                      }
                      <span>{{ getSnapshotName(item.productSnapshot) }}</span>
                    </div>
                  </td>
                  <td>{{ formatCurrency(item.price) }}</td>
                  <td>{{ item.quantity }}</td>
                  <td>{{ formatCurrency(item.totalPrice) }}</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>

      <!-- Order Summary -->
      <div class="mb-3">
        <div class="d-flex justify-content-between mb-2">
          <span>{{ 'ADMIN.ORDERS.SUBTOTAL' | translate }}:</span>
          <span>{{ formatCurrency(selectedOrder()!.subtotal) }}</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span>{{ 'ADMIN.ORDERS.SHIPPING' | translate }}:</span>
          <span>{{ formatCurrency(selectedOrder()!.shippingCost) }}</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span>{{ 'ADMIN.ORDERS.DISCOUNT' | translate }}:</span>
          <span>{{ formatCurrency(selectedOrder()!.discount) }}</span>
        </div>
        <hr />
        <div class="d-flex justify-content-between">
          <strong>{{ 'ADMIN.ORDERS.TOTAL' | translate }}:</strong>
          <strong>{{ formatCurrency(selectedOrder()!.total) }}</strong>
        </div>
      </div>

      <!-- Status -->
      <div class="row">
        <div class="col-md-6">
          <h6 class="text-muted">{{ 'ADMIN.ORDERS.ORDER_STATUS' | translate }}</h6>
          <p-tag
            [value]="selectedOrder()!.status"
            [severity]="getOrderStatusSeverity(selectedOrder()!.status)"
          ></p-tag>
        </div>
        <div class="col-md-6">
          <h6 class="text-muted">{{ 'ADMIN.ORDERS.PAYMENT_STATUS' | translate }}</h6>
          <p-tag
            [value]="selectedOrder()!.paymentStatus"
            [severity]="getPaymentStatusSeverity(selectedOrder()!.paymentStatus)"
          ></p-tag>
        </div>
      </div>

      @if (selectedOrder()!.notes) {
        <div class="mt-3">
          <h6 class="text-muted">{{ 'ADMIN.ORDERS.NOTES' | translate }}</h6>
          <p>{{ selectedOrder()!.notes }}</p>
        </div>
      }
    </div>
  }
</p-dialog>

<!-- Update Order Status Dialog -->
<p-dialog
  [(visible)]="showStatusDialog"
  [header]="'ðŸ”„ ' + ('ADMIN.ORDERS.UPDATE_ORDER_STATUS_TITLE' | translate)"
  [modal]="true"
  [style]="{ width: '400px' }"
  [closable]="true"
  [draggable]="false"
  [resizable]="false"
  (onHide)="closeStatusDialog()"
>
  <div class="mb-3">
    <label class="form-label">{{ 'ADMIN.ORDERS.ORDER_STATUS_REQUIRED' | translate }} <span class="text-danger">{{ 'ADMIN.ORDERS.REQUIRED_FIELD' | translate }}</span></label>
    <p-select
      [options]="orderStatusSelectOptions"
      [(ngModel)]="newOrderStatus"
      optionLabel="label"
      optionValue="value"
      [placeholder]="'ADMIN.ORDERS.SELECT_STATUS_PLACEHOLDER' | translate"
      [appendTo]="'body'"
      class="w-100"
    ></p-select>
  </div>

  <div class="d-flex justify-content-end gap-2 mt-4">
    <button
      pButton
      type="button"
      [label]="'ADMIN.ORDERS.CANCEL_BUTTON' | translate"
      class="p-button-secondary"
      (click)="closeStatusDialog()"
    ></button>
    <button
      pButton
      type="button"
      [label]="'ADMIN.ORDERS.UPDATE_STATUS_BUTTON' | translate"
      class="p-button-primary"
      (click)="updateOrderStatus()"
    ></button>
  </div>
</p-dialog>

<!-- Update Payment Status Dialog -->
<p-dialog
  [(visible)]="showPaymentDialog"
  [header]="'ðŸ’³ ' + ('ADMIN.ORDERS.UPDATE_PAYMENT_STATUS_TITLE' | translate)"
  [modal]="true"
  [style]="{ width: '400px' }"
  [closable]="true"
  [draggable]="false"
  [resizable]="false"
  (onHide)="closePaymentDialog()"
>
  <div class="mb-3">
    <label class="form-label">{{ 'ADMIN.ORDERS.PAYMENT_STATUS_REQUIRED' | translate }} <span class="text-danger">{{ 'ADMIN.ORDERS.REQUIRED_FIELD' | translate }}</span></label>
    <p-select
      [options]="paymentStatusSelectOptions"
      [(ngModel)]="newPaymentStatus"
      optionLabel="label"
      optionValue="value"
      [placeholder]="'ADMIN.ORDERS.SELECT_STATUS_PLACEHOLDER' | translate"
      [appendTo]="'body'"
      class="w-100"
    ></p-select>
  </div>

  <div class="d-flex justify-content-end gap-2 mt-4">
    <button
      pButton
      type="button"
      [label]="'ADMIN.ORDERS.CANCEL_BUTTON' | translate"
      class="p-button-secondary"
      (click)="closePaymentDialog()"
    ></button>
    <button
      pButton
      type="button"
      [label]="'ADMIN.ORDERS.UPDATE_STATUS_BUTTON' | translate"
      class="p-button-primary"
      (click)="updatePaymentStatus()"
    ></button>
  </div>
</p-dialog>

<!-- Toast for notifications -->
<p-toast position="top-right"></p-toast>

<!-- Confirmation dialog -->
<p-confirmDialog></p-confirmDialog>
