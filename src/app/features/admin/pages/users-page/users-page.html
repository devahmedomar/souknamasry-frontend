<div class="container-fluid p-4">
  <!-- Header -->
  <div class="page-header d-flex justify-content-between align-items-center">
    <div>
      <h1>ðŸ‘¥ {{ 'ADMIN.USERS.TITLE' | translate }}</h1>
      <p>{{ 'ADMIN.USERS.SUBTITLE' | translate }}</p>
    </div>
    <p-button
      [label]="'ADMIN.USERS.ADD_NEW_USER' | translate"
      icon="pi pi-plus"
      styleClass="add-button"
      (click)="openCreateDialog()">
    </p-button>
  </div>

  <!-- Filters -->
  <div class="filters-card">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label small text-muted">{{ 'ADMIN.USERS.SEARCH_LABEL' | translate }}</label>
          <span class="p-input-icon-left w-100">
            <i class="pi pi-search"></i>
            <input
              type="text"
              pInputText
              [placeholder]="'ADMIN.USERS.SEARCH_PLACEHOLDER' | translate"
              class="w-100"
              [(ngModel)]="searchTerm"
              (keyup.enter)="onSearch()"
            />
          </span>
        </div>
        <div class="col-md-3">
          <label class="form-label small text-muted">{{ 'ADMIN.USERS.ROLE_LABEL' | translate }}</label>
          <p-select
            [options]="roleOptions"
            [(ngModel)]="selectedRole"
            optionLabel="label"
            optionValue="value"
            [placeholder]="'ADMIN.USERS.SELECT_ROLE_PLACEHOLDER' | translate"
            class="w-100"
            (onChange)="onFilterChange()"
          ></p-select>
        </div>
        <div class="col-md-3">
          <label class="form-label small text-muted">{{ 'ADMIN.USERS.STATUS_LABEL' | translate }}</label>
          <p-select
            [options]="statusOptions"
            [(ngModel)]="selectedStatus"
            optionLabel="label"
            optionValue="value"
            [placeholder]="'ADMIN.USERS.SELECT_STATUS_PLACEHOLDER' | translate"
            class="w-100"
            (onChange)="onFilterChange()"
          ></p-select>
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button
            pButton
            type="button"
            [label]="'ADMIN.USERS.SEARCH_BUTTON' | translate"
            icon="pi pi-search"
            class="w-100"
            (click)="onSearch()"
          ></button>
        </div>
      </div>
    </div>
  </div>

  <!-- Users Table -->
  <div class="table-card">
    <p-table
        [value]="users()"
        [loading]="loading()"
        [paginator]="true"
        [rows]="rowsPerPage()"
        [totalRecords]="totalRecords()"
        [lazy]="true"
        (onLazyLoad)="onPageChange($event)"
        [rowsPerPageOptions]="[10, 20, 50, 100]"
        [showCurrentPageReport]="true"
        [currentPageReportTemplate]="'ADMIN.USERS.PAGINATION_TEXT' | translate"
        styleClass="p-datatable-striped"
      >
        <ng-template pTemplate="header">
          <tr>
            <th>{{ 'ADMIN.USERS.TABLE_NAME' | translate }}</th>
            <th>{{ 'ADMIN.USERS.TABLE_EMAIL' | translate }}</th>
            <th>{{ 'ADMIN.USERS.TABLE_PHONE' | translate }}</th>
            <th>{{ 'ADMIN.USERS.TABLE_CITY' | translate }}</th>
            <th>{{ 'ADMIN.USERS.TABLE_ROLE' | translate }}</th>
            <th>{{ 'ADMIN.USERS.TABLE_STATUS' | translate }}</th>
            <th>{{ 'ADMIN.USERS.TABLE_CREATED_AT' | translate }}</th>
            <th style="width: 200px;">{{ 'ADMIN.USERS.TABLE_ACTIONS' | translate }}</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-user>
          <tr>
            <td>
              <div class="d-flex align-items-center">
                @if (user.imageUrl) {
                  <img
                    [src]="user.imageUrl"
                    [alt]="user.firstName"
                    class="user-avatar me-2"
                  />
                } @else {
                  <div class="user-initials me-2">
                    {{ user.firstName.charAt(0) }}{{ user.lastName.charAt(0) }}
                  </div>
                }
                <span>{{ user.firstName }} {{ user.lastName }}</span>
              </div>
            </td>
            <td>{{ user.email }}</td>
            <td>{{ user.phone || '-' }}</td>
            <td>{{ user.city || '-' }}</td>
            <td>
              <p-tag
                [value]="user.role"
                [severity]="getRoleSeverity(user.role)"
              ></p-tag>
            </td>
            <td>
              <p-tag
                [value]="(user.isActive ? 'ADMIN.USERS.STATUS_ACTIVE' : 'ADMIN.USERS.STATUS_INACTIVE') | translate"
                [severity]="getStatusSeverity(user.isActive)"
              ></p-tag>
            </td>
            <td>{{ user.createdAt | date: 'short' }}</td>
            <td>
              <div class="d-flex gap-2">
                <button
                  pButton
                  type="button"
                  icon="pi pi-pencil"
                  class="p-button-rounded p-button-text p-button-sm"
                  [pTooltip]="'ADMIN.USERS.EDIT_TOOLTIP' | translate"
                  (click)="openEditDialog(user)"
                ></button>
                <button
                  pButton
                  type="button"
                  [icon]="user.isActive ? 'pi pi-ban' : 'pi pi-check'"
                  class="p-button-rounded p-button-text p-button-sm"
                  [pTooltip]="(user.isActive ? 'ADMIN.USERS.DEACTIVATE_TOOLTIP' : 'ADMIN.USERS.ACTIVATE_TOOLTIP') | translate"
                  (click)="toggleUserStatus(user)"
                ></button>
                <button
                  pButton
                  type="button"
                  icon="pi pi-trash"
                  class="p-button-rounded p-button-text p-button-danger p-button-sm"
                  [pTooltip]="'ADMIN.USERS.DELETE_TOOLTIP' | translate"
                  (click)="deleteUser(user)"
                ></button>
              </div>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="8" class="text-center py-5">
              <i class="pi pi-users" style="font-size: 4rem; color: #cbd5e1;"></i>
              <p class="text-muted mt-3 mb-0" style="font-size: 1.125rem; font-weight: 500;">{{ 'ADMIN.USERS.NO_USERS_FOUND' | translate }}</p>
              <p class="text-muted" style="font-size: 0.875rem;">{{ 'ADMIN.USERS.NO_USERS_MESSAGE' | translate }}</p>
            </td>
          </tr>
        </ng-template>
      </p-table>
  </div>
</div>

<!-- User Form Dialog -->
<p-dialog
  [(visible)]="showDialog"
  [header]="(isEditMode() ? 'âœï¸ ' + ('ADMIN.USERS.EDIT_USER_TITLE' | translate) : 'âž• ' + ('ADMIN.USERS.CREATE_USER_TITLE' | translate))"
  [modal]="true"
  [style]="{ width: '600px' }"
  [closable]="true"
  [draggable]="false"
  [resizable]="false"
  (onHide)="closeDialog()"
>
  <form [formGroup]="userForm" (ngSubmit)="saveUser()">
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">{{ 'ADMIN.USERS.FIRST_NAME_LABEL' | translate }} <span class="text-danger">{{ 'ADMIN.USERS.REQUIRED_FIELD' | translate }}</span></label>
        <input
          type="text"
          pInputText
          class="w-100"
          formControlName="firstName"
          [placeholder]="'ADMIN.USERS.FIRST_NAME_PLACEHOLDER' | translate"
        />
        @if (userForm.get('firstName')?.invalid && userForm.get('firstName')?.touched) {
          <small class="text-danger">{{ 'ADMIN.USERS.FIRST_NAME_REQUIRED' | translate }}</small>
        }
      </div>

      <div class="col-md-6">
        <label class="form-label">{{ 'ADMIN.USERS.LAST_NAME_LABEL' | translate }} <span class="text-danger">{{ 'ADMIN.USERS.REQUIRED_FIELD' | translate }}</span></label>
        <input
          type="text"
          pInputText
          class="w-100"
          formControlName="lastName"
          [placeholder]="'ADMIN.USERS.LAST_NAME_PLACEHOLDER' | translate"
        />
        @if (userForm.get('lastName')?.invalid && userForm.get('lastName')?.touched) {
          <small class="text-danger">{{ 'ADMIN.USERS.LAST_NAME_REQUIRED' | translate }}</small>
        }
      </div>

      <div class="col-md-12">
        <label class="form-label">{{ 'ADMIN.USERS.EMAIL_LABEL' | translate }} <span class="text-danger">{{ 'ADMIN.USERS.REQUIRED_FIELD' | translate }}</span></label>
        <input
          type="email"
          pInputText
          class="w-100"
          formControlName="email"
          [placeholder]="'ADMIN.USERS.EMAIL_PLACEHOLDER' | translate"
        />
        @if (userForm.get('email')?.invalid && userForm.get('email')?.touched) {
          <small class="text-danger">{{ 'ADMIN.USERS.EMAIL_REQUIRED' | translate }}</small>
        }
      </div>

      @if (!isEditMode()) {
        <div class="col-md-12">
          <label class="form-label">{{ 'ADMIN.USERS.PASSWORD_LABEL' | translate }} <span class="text-danger">{{ 'ADMIN.USERS.REQUIRED_FIELD' | translate }}</span></label>
          <input
            type="password"
            pInputText
            class="w-100"
            formControlName="password"
            [placeholder]="'ADMIN.USERS.PASSWORD_PLACEHOLDER' | translate"
          />
          @if (userForm.get('password')?.invalid && userForm.get('password')?.touched) {
            <small class="text-danger">{{ 'ADMIN.USERS.PASSWORD_REQUIRED' | translate }}</small>
          }
        </div>
      }

      <div class="col-md-6">
        <label class="form-label">{{ 'ADMIN.USERS.PHONE_LABEL' | translate }}</label>
        <input
          type="tel"
          pInputText
          class="w-100"
          formControlName="phone"
          [placeholder]="'ADMIN.USERS.PHONE_PLACEHOLDER' | translate"
        />
      </div>

      <div class="col-md-6">
        <label class="form-label">{{ 'ADMIN.USERS.CITY_LABEL' | translate }}</label>
        <input
          type="text"
          pInputText
          class="w-100"
          formControlName="city"
          [placeholder]="'ADMIN.USERS.CITY_PLACEHOLDER' | translate"
        />
      </div>

      <div class="col-md-6">
        <label class="form-label">{{ 'ADMIN.USERS.ROLE_LABEL' | translate }} <span class="text-danger">{{ 'ADMIN.USERS.REQUIRED_FIELD' | translate }}</span></label>
        <p-select
          [options]="[
            { label: ('ADMIN.USERS.ROLE_CUSTOMER' | translate), value: 'customer' },
            { label: ('ADMIN.USERS.ROLE_ADMIN' | translate), value: 'admin' }
          ]"
          formControlName="role"
          optionLabel="label"
          optionValue="value"
          [placeholder]="'ADMIN.USERS.SELECT_ROLE_PLACEHOLDER' | translate"
          [appendTo]="'body'"
          class="w-100"
        ></p-select>
      </div>

      <div class="col-md-6">
        <label class="form-label">{{ 'ADMIN.USERS.STATUS_LABEL' | translate }} <span class="text-danger">{{ 'ADMIN.USERS.REQUIRED_FIELD' | translate }}</span></label>
        <p-select
          [options]="[
            { label: ('ADMIN.USERS.STATUS_ACTIVE' | translate), value: true },
            { label: ('ADMIN.USERS.STATUS_INACTIVE' | translate), value: false }
          ]"
          formControlName="isActive"
          optionLabel="label"
          optionValue="value"
          [placeholder]="'ADMIN.USERS.SELECT_STATUS_PLACEHOLDER' | translate"
          [appendTo]="'body'"
          class="w-100"
        ></p-select>
      </div>

      <div class="col-md-12">
        <label class="form-label">{{ 'ADMIN.USERS.IMAGE_URL_LABEL' | translate }}</label>
        <input
          type="url"
          pInputText
          class="w-100"
          formControlName="imageUrl"
          [placeholder]="'ADMIN.USERS.IMAGE_URL_PLACEHOLDER' | translate"
        />
      </div>
    </div>

    <div class="d-flex justify-content-end gap-2 mt-4">
      <button
        pButton
        type="button"
        [label]="'ADMIN.USERS.CANCEL_BUTTON' | translate"
        class="p-button-secondary"
        (click)="closeDialog()"
      ></button>
      <button
        pButton
        type="submit"
        [label]="(isEditMode() ? 'ADMIN.USERS.UPDATE_BUTTON' : 'ADMIN.USERS.CREATE_BUTTON') | translate"
        class="p-button-primary"
        [disabled]="userForm.invalid"
      ></button>
    </div>
  </form>
</p-dialog>

<!-- Toast for notifications -->
<p-toast position="top-right"></p-toast>

<!-- Confirmation dialog -->
<p-confirmDialog></p-confirmDialog>
