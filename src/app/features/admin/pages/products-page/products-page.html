<div class="container-fluid p-4">
  <!-- Header -->
  <div class="page-header d-flex justify-content-between align-items-center">
    <div>
      <h1>üõçÔ∏è Product Management</h1>
      <p>Manage all products in your store</p>
    </div>
    <p-button
      label="Add New Product"
      icon="pi pi-plus"
      styleClass="add-button"
      (click)="openCreateDialog()">
    </p-button>
  </div>

  <!-- Filters -->
  <div class="filters-card">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label small text-muted">Search</label>
          <span class="p-input-icon-left w-100">
            <i class="pi pi-search"></i>
            <input
              type="text"
              pInputText
              placeholder="Search products..."
              class="w-100"
              [(ngModel)]="searchTerm"
              (keyup.enter)="onSearch()"
            />
          </span>
        </div>
        <div class="col-md-2">
          <label class="form-label small text-muted">Category</label>
          <p-select
            [options]="getCategoryOptions()"
            [(ngModel)]="selectedCategory"
            optionLabel="label"
            optionValue="value"
            placeholder="Select Category"
            class="w-100"
            (onChange)="onFilterChange()"
          ></p-select>
        </div>
        <div class="col-md-2">
          <label class="form-label small text-muted">Status</label>
          <p-select
            [options]="activeStatusOptions"
            [(ngModel)]="selectedActiveStatus"
            optionLabel="label"
            optionValue="value"
            placeholder="Select Status"
            class="w-100"
            (onChange)="onFilterChange()"
          ></p-select>
        </div>
        <div class="col-md-2">
          <label class="form-label small text-muted">Stock</label>
          <p-select
            [options]="stockStatusOptions"
            [(ngModel)]="selectedStockStatus"
            optionLabel="label"
            optionValue="value"
            placeholder="Select Stock"
            class="w-100"
            (onChange)="onFilterChange()"
          ></p-select>
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button
            pButton
            type="button"
            label="Search"
            icon="pi pi-search"
            class="w-100"
            (click)="onSearch()"
          ></button>
        </div>
      </div>
    </div>
  </div>

  <!-- Products Table -->
  <div class="table-card">
    <p-table
        [value]="products()"
        [loading]="loading()"
        [paginator]="true"
        [rows]="rowsPerPage()"
        [totalRecords]="totalRecords()"
        [lazy]="true"
        (onLazyLoad)="onPageChange($event)"
        [rowsPerPageOptions]="[10, 20, 50, 100]"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Showing {first} to {last} of {totalRecords} products"
        styleClass="p-datatable-striped"
      >
        <ng-template pTemplate="header">
          <tr>
            <th style="width: 80px;">Image</th>
            <th>Name</th>
            <th>Category</th>
            <th>Price</th>
            <th>Stock</th>
            <th>Status</th>
            <th style="width: 250px;">Actions</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-product>
          <tr>
            <td>
              @if (product.images && product.images.length > 0) {
                <img
                  [src]="product.images[0]"
                  [alt]="product.name"
                  class="product-thumbnail"
                />
              } @else {
                <div class="product-placeholder">
                  <i class="pi pi-image"></i>
                </div>
              }
            </td>
            <td>
              <div>
                <strong>{{ product.name }}</strong>
                @if (product.nameAr) {
                  <br /><small class="text-muted">{{ product.nameAr }}</small>
                }
              </div>
            </td>
            <td>{{ product.category.name }}</td>
            <td>{{ formatCurrency(product.price) }}</td>
            <td>
              <div class="d-flex align-items-center gap-2">
                <span>{{ product.stockQuantity }}</span>
                <p-tag
                  [value]="product.inStock ? 'In Stock' : 'Out of Stock'"
                  [severity]="getStockSeverity(product.inStock)"
                ></p-tag>
              </div>
            </td>
            <td>
              <p-tag
                [value]="product.isActive ? 'Active' : 'Inactive'"
                [severity]="getActiveSeverity(product.isActive)"
              ></p-tag>
            </td>
            <td>
              <div class="d-flex gap-2">
                <button
                  pButton
                  type="button"
                  icon="pi pi-pencil"
                  class="p-button-rounded p-button-text p-button-sm"
                  pTooltip="Edit"
                  (click)="openEditDialog(product)"
                ></button>
                <button
                  pButton
                  type="button"
                  icon="pi pi-box"
                  class="p-button-rounded p-button-text p-button-sm"
                  pTooltip="Update Stock"
                  (click)="openStockDialog(product)"
                ></button>
                <button
                  pButton
                  type="button"
                  [icon]="product.isActive ? 'pi pi-eye-slash' : 'pi pi-eye'"
                  class="p-button-rounded p-button-text p-button-sm"
                  [pTooltip]="product.isActive ? 'Deactivate' : 'Activate'"
                  (click)="toggleProductActive(product)"
                ></button>
                <button
                  pButton
                  type="button"
                  icon="pi pi-trash"
                  class="p-button-rounded p-button-text p-button-danger p-button-sm"
                  pTooltip="Delete"
                  (click)="deleteProduct(product)"
                ></button>
              </div>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="7" class="text-center py-5">
              <i class="pi pi-box" style="font-size: 4rem; color: #cbd5e1;"></i>
              <p class="text-muted mt-3 mb-0" style="font-size: 1.125rem; font-weight: 500;">No products found</p>
              <p class="text-muted" style="font-size: 0.875rem;">Add your first product to get started</p>
            </td>
          </tr>
        </ng-template>
      </p-table>
  </div>
</div>

<!-- Product Form Dialog -->
<p-dialog
  [(visible)]="showDialog"
  [header]="isEditMode() ? '‚úèÔ∏è Edit Product' : '‚ûï Create New Product'"
  [modal]="true"
  [style]="{ width: '800px' }"
  [closable]="true"
  [draggable]="false"
  [resizable]="false"
  (onHide)="closeDialog()"
>
  <form [formGroup]="productForm" (ngSubmit)="saveProduct()">
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Name (English) <span class="text-danger">*</span></label>
        <input
          type="text"
          pInputText
          class="w-100"
          formControlName="name"
          placeholder="Enter product name"
        />
        @if (productForm.get('name')?.invalid && productForm.get('name')?.touched) {
          <small class="text-danger">Name is required (min 2 characters)</small>
        }
      </div>

      <div class="col-md-6">
        <label class="form-label">Name (Arabic)</label>
        <input
          type="text"
          pInputText
          class="w-100"
          formControlName="nameAr"
          placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ®ÿßŸÑÿπÿ±ÿ®Ÿäÿ©"
        />
      </div>

      <div class="col-md-12">
        <label class="form-label">Description (English) <span class="text-danger">*</span></label>
        <textarea
          pInputTextarea
          class="w-100"
          formControlName="description"
          placeholder="Enter product description"
          rows="3"
        ></textarea>
        @if (productForm.get('description')?.invalid && productForm.get('description')?.touched) {
          <small class="text-danger">Description is required</small>
        }
      </div>

      <div class="col-md-12">
        <label class="form-label">Description (Arabic)</label>
        <textarea
          pInputTextarea
          class="w-100"
          formControlName="descriptionAr"
          placeholder="ŸàÿµŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ®ÿßŸÑÿπÿ±ÿ®Ÿäÿ©"
          rows="3"
        ></textarea>
      </div>

      <div class="col-md-4">
        <label class="form-label">Price (EGP) <span class="text-danger">*</span></label>
        <p-inputNumber
          formControlName="price"
          mode="currency"
          currency="EGP"
          locale="en-US"
          class="w-100"
          [min]="0"
        ></p-inputNumber>
        @if (productForm.get('price')?.invalid && productForm.get('price')?.touched) {
          <small class="text-danger">Price is required</small>
        }
      </div>

      <div class="col-md-4">
        <label class="form-label">Stock Quantity <span class="text-danger">*</span></label>
        <p-inputNumber
          formControlName="stockQuantity"
          class="w-100"
          [min]="0"
          [showButtons]="true"
        ></p-inputNumber>
        @if (productForm.get('stockQuantity')?.invalid && productForm.get('stockQuantity')?.touched) {
          <small class="text-danger">Stock quantity is required</small>
        }
      </div>

      <div class="col-md-4">
        <label class="form-label">Category <span class="text-danger">*</span></label>
        <p-select
          [options]="getCategorySelectOptions()"
          formControlName="category"
          optionLabel="label"
          optionValue="value"
          placeholder="Select Category"
          [appendTo]="'body'"
          class="w-100"
        ></p-select>
        @if (productForm.get('category')?.invalid && productForm.get('category')?.touched) {
          <small class="text-danger">Category is required</small>
        }
      </div>

      <div class="col-md-12">
        <label class="form-label">Product Images <span class="text-danger">*</span></label>
        <div formArrayName="images">
          @for (control of images.controls; track $index) {
            <div class="d-flex gap-2 mb-2">
              <input
                type="url"
                pInputText
                class="flex-grow-1"
                [formControlName]="$index"
                placeholder="Enter image URL"
              />
              @if (images.length > 1) {
                <button
                  pButton
                  type="button"
                  icon="pi pi-times"
                  class="p-button-danger p-button-sm"
                  (click)="removeImageField($index)"
                ></button>
              }
            </div>
          }
        </div>
        <button
          pButton
          type="button"
          label="Add Image"
          icon="pi pi-plus"
          class="p-button-sm p-button-outlined mt-2"
          (click)="addImageField()"
        ></button>
      </div>

      <div class="col-md-6">
        <div class="form-check">
          <input
            type="checkbox"
            class="form-check-input"
            id="inStock"
            formControlName="inStock"
          />
          <label class="form-check-label" for="inStock">In Stock</label>
        </div>
      </div>

      <div class="col-md-6">
        <div class="form-check">
          <input
            type="checkbox"
            class="form-check-input"
            id="isActive"
            formControlName="isActive"
          />
          <label class="form-check-label" for="isActive">Active</label>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-end gap-2 mt-4">
      <button
        pButton
        type="button"
        label="Cancel"
        class="p-button-secondary"
        (click)="closeDialog()"
      ></button>
      <button
        pButton
        type="submit"
        [label]="isEditMode() ? 'Update Product' : 'Create Product'"
        class="p-button-primary"
        [disabled]="productForm.invalid"
      ></button>
    </div>
  </form>
</p-dialog>

<!-- Stock Update Dialog -->
<p-dialog
  [(visible)]="showStockDialog"
  header="üì¶ Update Stock"
  [modal]="true"
  [style]="{ width: '400px' }"
  [closable]="true"
  [draggable]="false"
  [resizable]="false"
  (onHide)="closeStockDialog()"
>
  <form [formGroup]="stockForm" (ngSubmit)="updateStock()">
    <div class="mb-3">
      <label class="form-label">Stock Quantity <span class="text-danger">*</span></label>
      <p-inputNumber
        formControlName="stockQuantity"
        class="w-100"
        [min]="0"
        [showButtons]="true"
      ></p-inputNumber>
      @if (stockForm.get('stockQuantity')?.invalid && stockForm.get('stockQuantity')?.touched) {
        <small class="text-danger">Stock quantity is required</small>
      }
    </div>

    <div class="d-flex justify-content-end gap-2 mt-4">
      <button
        pButton
        type="button"
        label="Cancel"
        class="p-button-secondary"
        (click)="closeStockDialog()"
      ></button>
      <button
        pButton
        type="submit"
        label="Update Stock"
        class="p-button-primary"
        [disabled]="stockForm.invalid"
      ></button>
    </div>
  </form>
</p-dialog>

<!-- Toast for notifications -->
<p-toast position="top-right"></p-toast>

<!-- Confirmation dialog -->
<p-confirmDialog></p-confirmDialog>
